<!DOCTYPE html>
<html>
<head>
    <title>Miami Unicorns: Natacha and Amanda's Giggly Adventure</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.22.1/full/pyodide.js"></script>
</head>
<body>
    <canvas id="canvas" width="800" height="600"></canvas>
    <script type="text/javascript">
        async function main() {
            let pyodide = await loadPyodide();
            await pyodide.loadPackage("pygame");
            await pyodide.runPythonAsync(`
import pygame
import random
import math
import js

pygame.init()

WIDTH, HEIGHT = 800, 600
canvas = js.document.getElementById('canvas')
screen = pygame.display.set_mode((WIDTH, HEIGHT), pygame.SRCALPHA, canvas)

# Colors
WHITE = (255, 255, 255)
BLACK = (0, 0, 0)
RAINBOW = [(255, 0, 0), (255, 165, 0), (255, 255, 0), (0, 255, 0), (0, 0, 255), (75, 0, 130), (238, 130, 238)]

# Load images
def load_image(url, scale=1):
    response = js.XMLHttpRequest.new()
    response.open('GET', url, False)
    response.responseType = 'arraybuffer'
    response.send(None)
    image_data = response.response
    image = pygame.image.load(js.Uint8Array.new(image_data))
    return pygame.transform.scale(image, (int(image.get_width() * scale), int(image.get_height() * scale)))

natacha = load_image("https://raw.githubusercontent.com/TiagoD33/miami-unicorns-game/main/assets/natacha.png", 0.2)
amanda = load_image("https://raw.githubusercontent.com/TiagoD33/miami-unicorns-game/main/assets/amanda.png", 0.2)
unicorn = load_image("https://raw.githubusercontent.com/TiagoD33/miami-unicorns-game/main/assets/unicorns.png", 0.1)
jetski = load_image("https://raw.githubusercontent.com/TiagoD33/miami-unicorns-game/main/assets/jetskis.png", 0.1)
champagne = load_image("https://raw.githubusercontent.com/TiagoD33/miami-unicorns-game/main/assets/champagne.png", 0.05)
fire_emoji = load_image("https://raw.githubusercontent.com/TiagoD33/miami-unicorns-game/main/assets/fire_emoji.png", 0.05)
background = load_image("https://raw.githubusercontent.com/TiagoD33/miami-unicorns-game/main/assets/flysandbar.png", 1)

class Player:
    def __init__(self, image, x, left_key, right_key, up_key, down_key, shoot_key):
        self.image = image
        self.rect = self.image.get_rect()
        self.rect.centerx = x
        self.rect.bottom = HEIGHT - 10
        self.speed = 5
        self.left_key = left_key
        self.right_key = right_key
        self.up_key = up_key
        self.down_key = down_key
        self.shoot_key = shoot_key
        self.unicorns = 0
        self.champagnes = 0
        self.float_offset = 0
        self.float_speed = 0.02

    def update(self):
        keys = pygame.key.get_pressed()
        if keys[self.left_key]:
            self.rect.x -= self.speed
        if keys[self.right_key]:
            self.rect.x += self.speed
        if keys[self.up_key]:
            self.rect.y -= self.speed
        if keys[self.down_key]:
            self.rect.y += self.speed
        
        self.rect.clamp_ip(pygame.Rect(0, HEIGHT // 4, WIDTH, 3 * HEIGHT // 4))
        
        self.float_offset = math.sin(pygame.time.get_ticks() * self.float_speed) * 3

    def draw(self):
        screen.blit(self.image, (self.rect.x, self.rect.y + self.float_offset))

    def shoot(self):
        return Projectile(self.rect.centerx, self.rect.top)

class Entity:
    def __init__(self, image, is_catchable):
        self.image = image
        self.rect = self.image.get_rect()
        self.rect.x = random.randint(0, WIDTH - self.rect.width)
        self.rect.bottom = 0
        self.is_catchable = is_catchable
        self.time = 0
        if not is_catchable:  # Jetski
            self.pattern = random.choice(["zigzag", "straight"])
            self.speed = random.uniform(0.7, 1.5)
            self.amplitude = random.randint(10, 30)
        else:  # Unicorn or Champagne
            self.speed = random.uniform(1, 2)

    def update(self):
        self.time += 1
        if self.is_catchable:
            self.rect.y += self.speed
        else:  # Jetski movements
            if self.pattern == "zigzag":
                self.rect.y += self.speed
                self.rect.x += math.sin(self.time * 0.1) * 2
            else:  # straight
                self.rect.y += self.speed

        # Keep jetskis on screen
        self.rect.x = max(0, min(self.rect.x, WIDTH - self.rect.width))

    def draw(self):
        screen.blit(self.image, self.rect)

class Projectile:
    def __init__(self, x, y):
        self.image = fire_emoji
        self.rect = self.image.get_rect()
        self.rect.centerx = x
        self.rect.bottom = y
        self.speed = -10

    def update(self):
        self.rect.y += self.speed

    def draw(self):
        screen.blit(self.image, self.rect)

class ParticleEffect:
    def __init__(self, x, y, color):
        self.particles = []
        for _ in range(20):
            particle = {
                'x': x,
                'y': y,
                'dx': random.uniform(-2, 2),
                'dy': random.uniform(-2, 2),
                'radius': random.randint(2, 5),
                'color': color,
                'life': random.randint(20, 40)
            }
            self.particles.append(particle)

    def update(self):
        for particle in self.particles[:]:
            particle['x'] += particle['dx']
            particle['y'] += particle['dy']
            particle['life'] -= 1
            if particle['life'] <= 0:
                self.particles.remove(particle)

    def draw(self):
        for particle in self.particles:
            pygame.draw.circle(screen, particle['color'], (int(particle['x']), int(particle['y'])), particle['radius'])

class TextPopup:
    def __init__(self, text, x, y, color):
        self.font = pygame.font.Font(None, 36)
        self.text = self.font.render(text, True, color)
        self.rect = self.text.get_rect(center=(x, y))
        self.life = 60
        self.y_offset = 0

    def update(self):
        self.life -= 1
        self.y_offset -= 1
        self.rect.y += self.y_offset

    def draw(self):
        alpha = min(255, self.life * 4)
        temp_surface = pygame.Surface(self.text.get_size(), pygame.SRCALPHA)
        temp_surface.fill((255, 255, 255, alpha))
        temp_surface.blit(self.text, (0, 0), special_flags=pygame.BLEND_RGBA_MULT)
        screen.blit(temp_surface, self.rect)

def show_intro():
    screen.blit(background, (0, 0))
    font = pygame.font.Font(None, 48)
    title = font.render("Miami Unicorns: A Giggly Adventure", True, WHITE)
    subtitle = font.render("Catch unicorns, pop champagne, dodge jetskis!", True, WHITE)
    start = font.render("Press SPACE to start the madness!", True, WHITE)
    screen.blit(title, (WIDTH // 2 - title.get_width() // 2, HEIGHT // 3))
    screen.blit(subtitle, (WIDTH // 2 - subtitle.get_width() // 2, HEIGHT // 2))
    screen.blit(start, (WIDTH // 2 - start.get_width() // 2, 2 * HEIGHT // 3))
    pygame.display.flip()

    waiting = True
    while waiting:
        for event in pygame.event.get():
            if event.type == pygame.KEYDOWN and event.key == pygame.K_SPACE:
                waiting = False
    return True

def main():
    if not show_intro():
        return

    clock = pygame.time.Clock()
    player1 = Player(natacha, WIDTH // 3, pygame.K_LEFT, pygame.K_RIGHT, pygame.K_UP, pygame.K_DOWN, pygame.K_SPACE)
    player2 = Player(amanda, 2 * WIDTH // 3, pygame.K_a, pygame.K_d, pygame.K_w, pygame.K_s, pygame.K_LCTRL)
    entities = []
    projectiles = []
    effects = []
    popups = []

    running = True
    while running:
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                running = False
            if event.type == pygame.KEYDOWN:
                if event.key == player1.shoot_key:
                    projectiles.append(player1.shoot())
                    popups.append(TextPopup("Pew!", player1.rect.centerx, player1.rect.top, (255, 0, 0)))
                elif event.key == player2.shoot_key:
                    projectiles.append(player2.shoot())
                    popups.append(TextPopup("Pew!", player2.rect.centerx, player2.rect.top, (0, 0, 255)))

        player1.update()
        player2.update()

        if random.randint(1, 60) == 1:
            entity_type = random.choice(["unicorn", "champagne", "jetski"])
            if entity_type == "unicorn":
                entities.append(Entity(unicorn, True))
            elif entity_type == "champagne":
                entities.append(Entity(champagne, True))
            else:
                entities.append(Entity(jetski, False))

        for entity in entities[:]:
            entity.update()
            if entity.rect.top > HEIGHT:
                entities.remove(entity)
            elif entity.rect.colliderect(player1.rect) or entity.rect.colliderect(player2.rect):
                if entity.is_catchable:
                    player = player1 if entity.rect.colliderect(player1.rect) else player2
                    if entity.image == unicorn:
                        player.unicorns += 1
                        popups.append(TextPopup("Unicorn!", entity.rect.centerx, entity.rect.centery, random.choice(RAINBOW)))
                    elif entity.image == champagne:
                        player.champagnes += 1
                        popups.append(TextPopup("Cheers!", entity.rect.centerx, entity.rect.centery, random.choice(RAINBOW)))
                    effects.append(ParticleEffect(entity.rect.centerx, entity.rect.centery, random.choice(RAINBOW)))
                    entities.remove(entity)

        for projectile in projectiles[:]:
            projectile.update()
            if projectile.rect.bottom < 0:
                projectiles.remove(projectile)
            else:
                for entity in entities[:]:
                    if not entity.is_catchable and projectile.rect.colliderect(entity.rect):
                        effects.append(ParticleEffect(entity.rect.centerx, entity.rect.centery, (255, 165, 0)))
                        popups.append(TextPopup("Boom!", entity.rect.centerx, entity.rect.centery, (255, 165, 0)))
                        entities.remove(entity)
                        projectiles.remove(projectile)
                        break

        screen.blit(background, (0, 0))
        for entity in entities:
            entity.draw()
        for projectile in projectiles:
            projectile.draw()
        player1.draw()
        player2.draw()
        for effect in effects[:]:
            effect.update()
            effect.draw()
            if not effect.particles:
                effects.remove(effect)
        for popup in popups[:]:
            popup.update()
            popup.draw()
            if popup.life <= 0:
                popups.remove(popup)

        font = pygame.font.Font(None, 36)
        score1 = font.render(f"Natacha: 🦄 {player1.unicorns} 🍾 {player1.champagnes}", True, WHITE)
        score2 = font.render(f"Amanda: 🦄 {player2.unicorns} 🍾 {player2.champagnes}", True, WHITE)
        screen.blit(score1, (10, 10))
        screen.blit(score2, (10, 50))

        pygame.display.flip()
        clock.tick(60)

main()
            `);
        }
        main();
    </script>
</body>
</html>
